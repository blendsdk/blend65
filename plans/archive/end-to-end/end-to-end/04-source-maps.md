# Phase 3: Source Maps & Debug Support

> **Status**: Planning  
> **Phase**: 3  
> **Priority**: MEDIUM  
> **Dependencies**: Phase 2 (Code Generation)  
> **Estimated Tasks**: 5

---

## Codebase Analysis (Validated)

**Source Location Infrastructure Already Exists:**

The codebase has **extensive source location tracking** built into all compiler phases:

1. **AST Level (`ast/base.ts`)**:
   - `SourceLocation` interface with `start`/`end` positions (line, column, offset)
   - Every AST node stores its location via `protected readonly location: SourceLocation`
   - `getLocation()` method on all nodes

2. **IL Level (`il/instructions.ts`)**:
   - IL instructions have `location?: SourceLocation` field
   - `ILPrinter` already supports `showSourceLocations` option
   - Metadata includes location tracking: `inst.metadata.location`

3. **IL Printer (`il/printer.ts`)** - Already Has Debug Output:
   ```typescript
   interface ILPrinterOptions {
     showSourceLocations?: boolean;  // ← Already exists!
   }
   
   // Line 280: Source location printing
   if (this.options.showSourceLocations && inst.metadata.location) {
     const loc = inst.metadata.location;
     parts.push(`; @${loc.start.line}:${loc.start.column}`);
   }
   ```

4. **Diagnostics System (`ast/diagnostics.ts`)**:
   - `DiagnosticCollector` uses `SourceLocation` for all error reporting
   - Location is tracked for errors, warnings, hints

**What DOESN'T Exist:**
- ❌ `codegen/source-mapper.ts` - Source to assembly mapping
- ❌ VICE label file generation
- ❌ Assembly writer integration with source tracking
- ❌ Debug mode configuration (`none`/`inline`/`vice`/`both`)

**Implementation Approach:**
- ✅ **REUSE** existing `SourceLocation` from `ast/base.ts`
- ✅ **LEVERAGE** IL instruction location metadata
- ✅ **EXTEND** ILPrinter patterns for assembly output

---

## Overview

Source maps provide debug information that maps generated 6502 assembly back to original Blend65 source code. This enables developers to:

1. See source locations in assembly output
2. Debug with VICE using meaningful labels
3. Trace execution back to source code
4. Understand generated code structure

---

## Debug Modes

### Configuration

```typescript
// Debug mode options (from blend65.json or CLI)
type DebugMode = 'none' | 'inline' | 'vice' | 'both';

// CLI: blend65 build -d inline
// CLI: blend65 build -d vice
// CLI: blend65 build -d both
// CLI: blend65 build --debug=both
```

### Mode Comparison

| Mode | Inline Comments | VICE Labels | Use Case |
|------|-----------------|-------------|----------|
| `none` | ❌ | ❌ | Production builds |
| `inline` | ✅ | ❌ | Assembly review |
| `vice` | ❌ | ✅ | VICE debugging |
| `both` | ✅ | ✅ | Full debugging |

---

## Inline Source Comments

### Format

```asm
; FILE:<filename> LINE:<line> COL:<column>
; [optional: source code snippet]
<generated instructions>
```

### Example

**Blend65 Source (game.blend:42-45):**
```js
function updatePlayer(): void {
  playerX = playerX + 1;
  if (playerX > 255) {
    playerX = 0;
  }
}
```

**Generated Assembly (with inline debug):**
```asm
; ---------------------------------------------------------------------------
; FILE:game.blend LINE:42 COL:1
; function updatePlayer(): void
_updatePlayer:
  
; FILE:game.blend LINE:43 COL:3
; playerX = playerX + 1
  LDA _playerX
  CLC
  ADC #$01
  STA _playerX
  
; FILE:game.blend LINE:44 COL:3
; if (playerX > 255)
  LDA _playerX
  CMP #$FF
  BCC .skip_reset
  
; FILE:game.blend LINE:45 COL:5
; playerX = 0
  LDA #$00
  STA _playerX
  
.skip_reset:
  RTS
```

---

## VICE Label File

### Format

VICE monitor supports loading label files with the `ll` (load labels) command.

```
# VICE label file generated by Blend65 Compiler
# Format: al <address> .<label>

al C:0810 .main
al C:0815 ._init_globals
al C:0830 ._updatePlayer
al C:0850 ._renderSprite
al C:0870 ._handleInput

# Variables
al C:D020 .borderColor
al C:D021 .backgroundColor
al C:0002 .playerX
al C:0003 .playerY

# Data
al C:1000 ._gameTitle
al C:1020 ._spriteData
```

### Usage in VICE

```
# Load the label file
ll "game.labels"

# Now you can use labels in monitor
> d .main           ; Disassemble from main
> m ._playerX       ; Show memory at playerX
> break .updatePlayer  ; Set breakpoint
```

---

## Implementation

### Source Mapper Class

```typescript
// codegen/source-mapper.ts

import type { SourceLocation } from '../ast/base.js';

/**
 * Tracks source-to-assembly mapping for debug information
 */
export class SourceMapper {
  /** Current assembly address (relative to code start) */
  protected currentAddress: number = 0;
  
  /** Collected source map entries */
  protected entries: SourceMapEntry[] = [];
  
  /** Label to address mapping for VICE */
  protected labels: Map<string, number> = new Map();
  
  /**
   * Reset mapper state
   */
  reset(): void {
    this.currentAddress = 0;
    this.entries = [];
    this.labels.clear();
  }
  
  /**
   * Update current address
   */
  setAddress(address: number): void {
    this.currentAddress = address;
  }
  
  /**
   * Advance address by instruction bytes
   */
  advanceAddress(bytes: number): void {
    this.currentAddress += bytes;
  }
  
  /**
   * Record source location at current address
   */
  recordLocation(source: SourceLocation, label?: string): void {
    this.entries.push({
      address: this.currentAddress,
      source,
      label,
    });
  }
  
  /**
   * Register a label at current address
   */
  registerLabel(name: string): void {
    this.labels.set(name, this.currentAddress);
  }
  
  /**
   * Get all entries
   */
  getEntries(): SourceMapEntry[] {
    return [...this.entries];
  }
  
  /**
   * Generate inline assembly comments
   */
  generateInlineComments(): Map<number, string> {
    const comments = new Map<number, string>();
    
    for (const entry of this.entries) {
      const { address, source } = entry;
      const comment = `; FILE:${source.source} LINE:${source.start.line} COL:${source.start.column}`;
      comments.set(address, comment);
    }
    
    return comments;
  }
  
  /**
   * Generate VICE label file content
   */
  generateViceLabels(codeStartAddress: number): string {
    const lines: string[] = [
      '# VICE label file generated by Blend65 Compiler',
      `# Generated: ${new Date().toISOString()}`,
      '#',
      '# Format: al <address> .<label>',
      '',
    ];
    
    // Sort labels by address
    const sortedLabels = Array.from(this.labels.entries())
      .sort((a, b) => a[1] - b[1]);
    
    // Group by type (functions, variables, data)
    const functions: [string, number][] = [];
    const variables: [string, number][] = [];
    const other: [string, number][] = [];
    
    for (const [name, offset] of sortedLabels) {
      const address = codeStartAddress + offset;
      
      if (name.startsWith('_') && !name.startsWith('__')) {
        functions.push([name, address]);
      } else if (address < 0x100) {
        variables.push([name, address]);
      } else {
        other.push([name, address]);
      }
    }
    
    // Output functions
    if (functions.length > 0) {
      lines.push('# Functions');
      for (const [name, address] of functions) {
        lines.push(`al C:${address.toString(16).padStart(4, '0').toUpperCase()} .${name}`);
      }
      lines.push('');
    }
    
    // Output variables
    if (variables.length > 0) {
      lines.push('# Zero-page variables');
      for (const [name, address] of variables) {
        lines.push(`al C:${address.toString(16).padStart(4, '0').toUpperCase()} .${name}`);
      }
      lines.push('');
    }
    
    // Output other labels
    if (other.length > 0) {
      lines.push('# Other labels');
      for (const [name, address] of other) {
        lines.push(`al C:${address.toString(16).padStart(4, '0').toUpperCase()} .${name}`);
      }
    }
    
    return lines.join('\n');
  }
}
```

### Assembly Writer Integration

```typescript
// codegen/assembly-writer.ts (additions)

export class AssemblyWriter {
  protected sourceMapper: SourceMapper;
  protected debugMode: DebugMode;
  
  /**
   * Emit instruction with source location
   */
  emitInstructionWithSource(
    instruction: string,
    operand: string | null,
    source?: SourceLocation
  ): void {
    // Emit source comment if debug mode enabled
    if (source && (this.debugMode === 'inline' || this.debugMode === 'both')) {
      this.emitLine(`; FILE:${source.source} LINE:${source.start.line} COL:${source.start.column}`);
    }
    
    // Emit the instruction
    this.emitInstruction(instruction, operand);
    
    // Record source mapping
    if (source) {
      this.sourceMapper.recordLocation(source);
    }
  }
  
  /**
   * Emit label with optional source
   */
  emitLabelWithSource(label: string, source?: SourceLocation): void {
    this.emitLabel(label);
    this.sourceMapper.registerLabel(label);
    
    if (source) {
      this.sourceMapper.recordLocation(source, label);
    }
  }
}
```

---

## Output Files

### File Extensions

| Debug Mode | Output Files |
|------------|--------------|
| `none` | `game.prg` |
| `inline` | `game.prg`, `game.asm` |
| `vice` | `game.prg`, `game.labels` |
| `both` | `game.prg`, `game.asm`, `game.labels` |

### File Naming

```typescript
function getOutputFiles(baseName: string, config: CompilerOptions): OutputFiles {
  const debug = config.debug || 'none';
  
  return {
    prg: `${baseName}.prg`,
    asm: (debug === 'inline' || debug === 'both') ? `${baseName}.asm` : undefined,
    labels: (debug === 'vice' || debug === 'both') ? `${baseName}.labels` : undefined,
  };
}
```

---

## Task Breakdown

### Task 3.1: Source Map Types
**File**: `packages/compiler/src/codegen/source-map-types.ts`

Define source map types.

```typescript
// Deliverables:
// - SourceMapEntry interface
// - SourceMapOptions interface
// - DebugMode type
```

**Acceptance Criteria:**
- [ ] All types defined
- [ ] JSDoc documentation
- [ ] Exported from codegen/index.ts

---

### Task 3.2: Source Mapper Implementation
**File**: `packages/compiler/src/codegen/source-mapper.ts`

Implement SourceMapper class.

```typescript
// Deliverables:
// - SourceMapper class
// - Address tracking
// - Label registration
// - Entry collection
```

**Acceptance Criteria:**
- [ ] Tracks source locations
- [ ] Generates inline comments
- [ ] Generates VICE labels
- [ ] Unit tests pass

---

### Task 3.3: Inline Comment Generation
**Files**: Update `assembly-writer.ts`

Integrate inline comments into assembly output.

```typescript
// Deliverables:
// - emitInstructionWithSource() method
// - Debug mode handling
// - Comment formatting
```

**Acceptance Criteria:**
- [ ] Comments appear before instructions
- [ ] Only when debug mode enabled
- [ ] Correct format
- [ ] Unit tests pass

---

### Task 3.4: VICE Label Generation
**Files**: Update `code-generator.ts`

Generate VICE-compatible label files.

```typescript
// Deliverables:
// - generateViceLabels() method
// - Correct VICE format
// - Label categorization
```

**Acceptance Criteria:**
- [ ] Valid VICE label format
- [ ] Labels load in VICE
- [ ] Functions, variables categorized
- [ ] Integration tests pass

---

### Task 3.5: Integration & Tests
**Files**: `packages/compiler/src/__tests__/codegen/source-maps.test.ts`

Comprehensive tests for source mapping.

```typescript
// Deliverables:
// - Source mapper unit tests
// - Inline comment tests
// - VICE label tests
// - Integration with CodeGenerator
```

**Acceptance Criteria:**
- [ ] All unit tests pass
- [ ] Labels work in VICE
- [ ] Inline comments readable
- [ ] No regressions in codegen

---

## Task Checklist

| Task | Description | Status |
|------|-------------|--------|
| 3.1 | Source Map Types | [ ] |
| 3.2 | Source Mapper Implementation | [ ] |
| 3.3 | Inline Comment Generation | [ ] |
| 3.4 | VICE Label Generation | [ ] |
| 3.5 | Integration & Tests | [ ] |

---

## Future Enhancements

### Source-Level Debugging (Future)

VICE 3.7+ supports experimental source-level debugging with `.dbg` files. This could enable:

- Stepping through Blend65 source in VICE
- Variable inspection by name
- Call stack display

**Format (conceptual):**
```
# VICE debug file
FILE 0 "game.blend"
LINE 0 42 $0830 $0840
LINE 0 43 $0840 $0850
SYMBOL 0 "playerX" $02 BYTE
SYMBOL 0 "score" $1000 WORD
```

This is deferred to a future phase as it requires significant VICE integration work.

---

**This document defines source map and debug support for Blend65.**