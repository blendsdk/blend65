# Phase 1: Source Maps & Debug Support

> **Document**: 03-source-maps.md
> **Parent**: [Index](00-index.md)
> **Phase**: 1
> **Sessions**: 2
> **Dependencies**: None

---

## Overview

Source maps provide debug information that maps generated 6502 assembly back to original Blend65 source code. This enables developers to:

1. See source locations in assembly output
2. Debug with VICE using meaningful labels
3. Trace execution back to source code
4. Understand generated code structure

---

## Debug Modes

### Configuration

```typescript
// Debug mode options (from blend65.json or CLI)
type DebugMode = 'none' | 'inline' | 'vice' | 'both';

// CLI: blend65 build -d inline
// CLI: blend65 build -d vice
// CLI: blend65 build -d both
// CLI: blend65 build --debug=both
```

### Mode Comparison

| Mode | Inline Comments | VICE Labels | Use Case |
|------|-----------------|-------------|----------|
| `none` | ❌ | ❌ | Production builds |
| `inline` | ✅ | ❌ | Assembly review |
| `vice` | ❌ | ✅ | VICE debugging |
| `both` | ✅ | ✅ | Full debugging |

---

## Inline Source Comments

### Format

```asm
; FILE:<filename> LINE:<line> COL:<column>
<generated instructions>
```

### Example

**Blend65 Source (game.blend:42-45):**
```js
function updatePlayer(): void {
  playerX = playerX + 1;
  if (playerX > 255) {
    playerX = 0;
  }
}
```

**Generated Assembly (with inline debug):**
```asm
; ---------------------------------------------------------------------------
; FILE:game.blend LINE:42 COL:1
; function updatePlayer(): void
_updatePlayer:
  
; FILE:game.blend LINE:43 COL:3
; playerX = playerX + 1
  LDA _playerX
  CLC
  ADC #$01
  STA _playerX
  
; FILE:game.blend LINE:44 COL:3
; if (playerX > 255)
  LDA _playerX
  CMP #$FF
  BCC .skip_reset
  
; FILE:game.blend LINE:45 COL:5
; playerX = 0
  LDA #$00
  STA _playerX
  
.skip_reset:
  RTS
```

---

## VICE Label File

### Format

VICE monitor supports loading label files with the `ll` (load labels) command.

```
# VICE label file generated by Blend65 Compiler
# Format: al <address> .<label>

al C:0810 .main
al C:0815 ._init_globals
al C:0830 ._updatePlayer
al C:0850 ._renderSprite

# Variables
al C:D020 .borderColor
al C:D021 .backgroundColor
al C:0002 .playerX
al C:0003 .playerY
```

### Usage in VICE

```
# Load the label file
ll "game.labels"

# Now you can use labels in monitor
> d .main           ; Disassemble from main
> m ._playerX       ; Show memory at playerX
> break .updatePlayer  ; Set breakpoint
```

---

## Implementation

### Source Mapper Class

```typescript
// codegen/source-mapper.ts

import type { SourceLocation } from '../ast/base.js';

export interface SourceMapEntry {
  address: number;
  source: SourceLocation;
  label?: string;
}

/**
 * Tracks source-to-assembly mapping for debug information
 */
export class SourceMapper {
  protected currentAddress: number = 0;
  protected entries: SourceMapEntry[] = [];
  protected labels: Map<string, number> = new Map();
  
  /** Reset mapper state */
  reset(): void;
  
  /** Update current address */
  setAddress(address: number): void;
  
  /** Advance address by instruction bytes */
  advanceAddress(bytes: number): void;
  
  /** Record source location at current address */
  recordLocation(source: SourceLocation, label?: string): void;
  
  /** Register a label at current address */
  registerLabel(name: string): void;
  
  /** Generate inline assembly comments */
  generateInlineComments(): Map<number, string>;
  
  /** Generate VICE label file content */
  generateViceLabels(codeStartAddress: number): string;
}
```

---

## Output Files

### File Extensions

| Debug Mode | Output Files |
|------------|--------------|
| `none` | `game.prg` |
| `inline` | `game.prg`, `game.asm` |
| `vice` | `game.prg`, `game.labels` |
| `both` | `game.prg`, `game.asm`, `game.labels` |

---

## Task Breakdown

### Task 1.1: Source Map Types
**File**: `packages/compiler/src/codegen/source-map-types.ts`

Define source map types.

**Deliverables:**
- `SourceMapEntry` interface
- `SourceMapOptions` interface
- `DebugMode` type

**Acceptance Criteria:**
- [ ] All types defined
- [ ] JSDoc documentation
- [ ] Exported from codegen/index.ts

---

### Task 1.2: Source Mapper Implementation
**File**: `packages/compiler/src/codegen/source-mapper.ts`

Implement SourceMapper class.

**Deliverables:**
- SourceMapper class
- Address tracking
- Label registration
- Entry collection

**Acceptance Criteria:**
- [ ] Tracks source locations
- [ ] Generates inline comments
- [ ] Generates VICE labels
- [ ] Unit tests pass

---

### Task 1.3: Inline Comment Generation
**Files**: Update `codegen/` as needed

Integrate inline comments into assembly output.

**Deliverables:**
- Debug mode handling
- Comment formatting
- Integration with assembly writer

**Acceptance Criteria:**
- [ ] Comments appear before instructions
- [ ] Only when debug mode enabled
- [ ] Correct format
- [ ] Unit tests pass

---

### Task 1.4: VICE Label Generation
**Files**: Update code generator

Generate VICE-compatible label files.

**Deliverables:**
- `generateViceLabels()` method
- Correct VICE format
- Label categorization

**Acceptance Criteria:**
- [ ] Valid VICE label format
- [ ] Labels load in VICE
- [ ] Functions, variables categorized
- [ ] Integration tests pass

---

### Task 1.5: Config & CLI Integration
**Files**: Update config and CLI

Add debug mode configuration.

**Deliverables:**
- `debug` option in blend65.json
- `-d` / `--debug` CLI flag
- Output file handling

**Acceptance Criteria:**
- [ ] Config option works
- [ ] CLI flag works
- [ ] Correct files generated
- [ ] Integration tests pass

---

## Task Checklist

| Task | Description | Status |
|------|-------------|--------|
| 1.1 | Source Map Types | [ ] |
| 1.2 | Source Mapper Implementation | [ ] |
| 1.3 | Inline Comment Generation | [ ] |
| 1.4 | VICE Label Generation | [ ] |
| 1.5 | Config & CLI Integration | [ ] |

---

**This document defines source map support for Blend65.**