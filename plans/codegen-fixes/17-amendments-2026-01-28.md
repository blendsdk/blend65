# Plan Amendments: 2026-01-28

> **Document**: 17-amendments-2026-01-28.md
> **Parent**: [Index](00-index.md)
> **Date**: 2026-01-28
> **Purpose**: Address gaps identified during plan review

---

## Overview

This document captures amendments to the codegen-fixes plan based on a comprehensive review that cross-referenced the plan against the Blend65 language specification.

---

## Amendment 1: Removed Opcodes

The following opcodes were **REMOVED** from Phase 2 (05-missing-opcodes.md) because the features they support are not in the current Blend65 language specification:

| Removed Opcode | Reason |
|----------------|--------|
| `LOAD_FIELD` | General struct types not in language |
| `STORE_FIELD` | General struct types not in language |
| `CALL_INDIRECT` | Function pointers not in language |

**Note:** MAP_LOAD_FIELD and MAP_STORE_FIELD are **KEPT** because @map struct-like layouts ARE in the language.

---

## Amendment 2: Switch Statement Verification Tests

Add the following tests to verify switch statement code generation works correctly:

### Test Cases

| Test | Description | Blend Code |
|------|-------------|------------|
| Switch.1 | Basic switch with 2-3 cases | `switch (x) { case 1: ... case 2: ... }` |
| Switch.2 | Case fall-through behavior | Cases without break fall through |
| Switch.3 | Break exits switch | `break;` jumps to end |
| Switch.4 | Default clause | `default:` catches unmatched |
| Switch.5 | Switch with const/enum values | `case GameState.MENU:` |

### Implementation

Add to Phase 12 (12-correctness-tests.md) or create new test file:

```typescript
describe('Switch Statement Code Generation', () => {
  it('should generate correct code for basic switch', () => {
    const asm = compileToAsm(`
      let x: byte = 2;
      let result: byte = 0;
      switch (x) {
        case 1:
          result = 10;
          break;
        case 2:
          result = 20;
          break;
        default:
          result = 0;
      }
    `);
    expectNoStubs(asm);
    expect(asm).toContain('CMP');  // Case comparison
  });

  it('should implement fall-through behavior', () => {
    const asm = compileToAsm(`
      let x: byte = 1;
      let result: byte = 0;
      switch (x) {
        case 1:
        case 2:
          result = 10;  // Both cases fall through here
      }
    `);
    expectNoStubs(asm);
  });

  it('should exit on break', () => {
    const asm = compileToAsm(`
      let x: byte = 1;
      let result: byte = 0;
      switch (x) {
        case 1:
          result = 10;
          break;
        case 2:
          result = 20;
      }
    `);
    expectNoStubs(asm);
    expect(asm).toContain('JMP');  // Break jumps to end
  });

  it('should handle default clause', () => {
    const asm = compileToAsm(`
      let x: byte = 99;
      let result: byte = 0;
      switch (x) {
        case 1:
          result = 10;
        default:
          result = 0;
      }
    `);
    expectNoStubs(asm);
  });
});
```

---

## Amendment 3: @address Type Verification

Add tests verifying `@address` type works correctly (it's a built-in alias for `word`):

```typescript
describe('@address Type Code Generation', () => {
  it('should handle @address parameters', () => {
    const asm = compileToAsm(`
      function fill(addr: @address, len: byte, value: byte): void {
        for (i = 0 to len - 1) {
          poke(addr + i, value);
        }
      }
    `);
    expectNoStubs(asm);
  });

  it('should allow @address variables', () => {
    const asm = compileToAsm(`
      @ram let buffer: byte[10];
      let bufferAddr: @address = @buffer;
      poke(bufferAddr, 42);
    `);
    expectNoStubs(asm);
  });

  it('should allow arithmetic on @address', () => {
    const asm = compileToAsm(`
      let addr: @address = 0x0400;
      let nextLine: @address = addr + 40;
    `);
    expectNoStubs(asm);
  });
});
```

---

## Amendment 4: Documentation Notes

### 4.1 All Types Are Unsigned

**Add to documentation:** All Blend65 types are **unsigned**. There are no int8 or int16 types.

- `byte`: 0-255 (unsigned 8-bit)
- `word`: 0-65535 (unsigned 16-bit)
- `boolean`: 0 or 1

**Code generation implications:**
- All comparison operators use **unsigned comparison** (BCC, BCS, BEQ, BNE)
- No need for signed comparison handling

### 4.2 Static 2D Array Optimization

**Add to documentation:** The compiler optimizes 2D array access:

| Pattern | Optimization |
|---------|--------------|
| `grid[2][3]` (both constant) | Offset computed at compile time |
| `screen[5][x]` (row constant) | Partial compile-time: `base+200+x` |
| `screen[y][x]` (both variable) | Runtime multiply required |

**Example:**
```js
let screen: byte[25][40];
screen[5][x] = 160;  // Compiles to: STA screen+200,X (no runtime multiply!)
```

### 4.3 Array Bounds Checking

**Add to documentation:**

- **Constant indices:** Bounds checked at **compile time**
  - `buffer[5]` where buffer is `byte[10]` â†’ âœ… Valid
  - `buffer[15]` where buffer is `byte[10]` â†’ âŒ Compile error

- **Variable indices:** **NO runtime bounds checking**
  - `buffer[i]` â†’ Programmer responsibility
  - This is standard for embedded/6502 development

---

## Amendment 5: Archive fix-oversight Plan

The `plans/fix-oversight/` directory should be moved to `plans/archive/` because:
- It addresses the same issues as `codegen-fixes`
- `codegen-fixes` is the canonical, comprehensive plan
- GAP-REPORT.md was created before `codegen-fixes` existed

**Action:** Move `plans/fix-oversight/` â†’ `plans/archive/fix-oversight/`

---

## Summary

| Amendment | Status | Impact |
|-----------|--------|--------|
| 1. Remove opcodes | âœ… Applied | 05-missing-opcodes.md updated |
| 2. Switch tests | ğŸ“‹ Documented | Add to Phase 12 |
| 3. @address tests | ğŸ“‹ Documented | Add to Phase 12 |
| 4. Documentation | ğŸ“‹ Documented | Add to relevant docs |
| 5. Archive plan | ğŸ“‹ Documented | Move fix-oversight to archive |

---

## Related Documents

- [Missing Opcodes](05-missing-opcodes.md) - Updated with opcode removals
- [Correctness Tests](12-correctness-tests.md) - Add switch/@address tests
- [Execution Plan](99-execution-plan.md) - Update task estimates