#!/bin/bash
#
# compiler-test - Targeted Compiler Test Runner
#
# Usage:
#   ./compiler-test              # Run ALL tests
#   ./compiler-test parser       # Run parser tests only
#   ./compiler-test lexer il     # Run lexer AND il tests
#   ./compiler-test semantic/type  # Run semantic/type* tests
#
# This script always performs clean + build before running tests
# to ensure a consistent test environment.
#

set -e  # Exit on error

# Always start with clean environment
clear && yarn clean && yarn build || {
  echo "Build failed. Cannot run tests."
  exit 1
}

if [ $# -eq 0 ]; then
  # No arguments = run all tests
  echo "Running all tests..."
  yarn test
else
  # Build OR pattern from all arguments
  # e.g., "lexer il" becomes "lexer|il"
  PATTERN=""
  for arg in "$@"; do
    if [ -z "$PATTERN" ]; then
      PATTERN="$arg"
    else
      PATTERN="$PATTERN|$arg"
    fi
  done

  echo "Running tests matching: $PATTERN"
  yarn vitest run "$PATTERN"
fi